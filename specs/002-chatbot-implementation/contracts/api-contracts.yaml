# Chatbot API Contracts

## Authentication Endpoints

### POST /api/auth/login
Authenticate user and return JWT token

**Request:**
```json
{
  "email": "user@example.com",
  "password": "user_password"
}
```

**Response (200):**
```json
{
  "access_token": "jwt_token_string",
  "token_type": "bearer",
  "expires_in": 3600
}
```

**Response (401):**
```json
{
  "error": "Invalid credentials"
}
```

### POST /api/auth/register
Register new user

**Request:**
```json
{
  "email": "user@example.com",
  "username": "username",
  "password": "secure_password"
}
```

**Response (201):**
```json
{
  "message": "User created successfully",
  "user_id": "uuid_string"
}
```

## Chat Endpoints

### POST /api/chatkit
ChatKit integration endpoint for real-time chat functionality

**Headers:**
```
Authorization: Bearer {jwt_token}
```

**Request:**
```json
{
  "thread_id": "thread_uuid",
  "input": {
    "content": [
      {
        "type": "text",
        "text": "User's message content"
      }
    ]
  }
}
```

**Response (200):**
```json
{
  "thread_id": "thread_uuid",
  "message": {
    "id": "message_uuid",
    "type": "assistant",
    "content": "Response from AI with contextual information",
    "source_references": [
      {
        "document_id": "doc_uuid",
        "title": "Document Title",
        "page": 42,
        "section": "Section Name",
        "excerpt": "Relevant text excerpt..."
      }
    ],
    "timestamp": "2025-12-09T10:30:00Z"
  }
}
```

### POST /api/chatkit/selection
Handle selection-based questions using only selected text

**Headers:**
```
Authorization: Bearer {jwt_token}
```

**Request:**
```json
{
  "selected_text": "Text that user has selected/highlighted",
  "question": "Question about the selected text",
  "thread_id": "thread_uuid"
}
```

**Response (200):**
```json
{
  "thread_id": "thread_uuid",
  "answer": "Response based only on selected text",
  "timestamp": "2025-12-09T10:30:00Z"
}
```

### GET /api/health
Health check endpoint

**Response (200):**
```json
{
  "status": "ok",
  "timestamp": "2025-12-09T10:30:00Z",
  "services": {
    "chatkit": "connected",
    "qdrant": "connected",
    "neon": "connected"
  }
}
```

## Conversation Management Endpoints

### GET /api/conversations
Retrieve user's conversations

**Headers:**
```
Authorization: Bearer {jwt_token}
```

**Response (200):**
```json
{
  "conversations": [
    {
      "id": "conversation_uuid",
      "title": "Conversation title",
      "created_at": "2025-12-09T10:00:00Z",
      "updated_at": "2025-12-09T10:30:00Z",
      "message_count": 5
    }
  ]
}
```

### GET /api/conversations/{conversation_id}
Retrieve specific conversation with message history

**Headers:**
```
Authorization: Bearer {jwt_token}
```

**Response (200):**
```json
{
  "conversation": {
    "id": "conversation_uuid",
    "title": "Conversation title",
    "created_at": "2025-12-09T10:00:00Z",
    "updated_at": "2025-12-09T10:30:00Z"
  },
  "messages": [
    {
      "id": "message_uuid",
      "type": "user",
      "content": "User's message",
      "timestamp": "2025-12-09T10:15:00Z"
    },
    {
      "id": "message_uuid",
      "type": "assistant",
      "content": "AI's response",
      "source_references": [...],
      "timestamp": "2025-12-09T10:16:00Z"
    }
  ]
}
```

### DELETE /api/conversations/{conversation_id}
Delete a specific conversation

**Headers:**
```
Authorization: Bearer {jwt_token}
```

**Response (200):**
```json
{
  "message": "Conversation deleted successfully"
}
```

## Error Responses

### Standard Error Format
```json
{
  "error": {
    "type": "error_type",
    "message": "Descriptive error message",
    "code": 400,
    "timestamp": "2025-12-09T10:30:00Z"
  }
}
```

### Common Error Types
- `AUTHENTICATION_ERROR`: Invalid or expired JWT token
- `AUTHORIZATION_ERROR`: User doesn't have permission for requested resource
- `VALIDATION_ERROR`: Request body doesn't match expected schema
- `SERVICE_UNAVAILABLE`: External service (Qdrant, Neon) is temporarily unavailable
- `RAG_ERROR`: Error occurred during RAG processing